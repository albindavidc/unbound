<%- include('../partials/admin/header') %>

<style>
  .userProfileMain {
    width: 100%;
    height: 30%;
    margin: 0 auto;
    background-color: rgb(0, 0, 0);
  }

  .userProfileH1 {
    width: 100%;
    margin: 10px;
    font-family: "Baloo", cursive;
    color: white;
    font-size: 6vw;
  }

  .breadcrumbCls {
    background-color: rgb(0, 0, 0);
  }
</style>

<section>
  <div class="pb-5 text-center">
    <div class="card userProfileMain rounded">
      <h1 class="userProfileH1">Order Managment</h1>
    </div>
  </div>
</section>

<section class="container my-5">
  <div class="container table-responsive text-capitalize">
    <table class="table table-striped table-hover">
      <thead>
        <tr class="text-center">
          <th scope="col">#</th>
          <th scope="col">Customer Name</th>
          <th scope="col">Date</th>
          <th scope="col">Product(s)</th>
          <th scope="col">Payment Status</th>
          <th scope="col">Payment Method</th>
          <th scope="col">Amount</th>
          <th scope="col">Delivery Status</th>
          <th scope="col">Action</th>
        </tr>
      </thead>
      <tbody>
        <% if (orders && orders.length > 0) { %> <% orders.forEach((order, index) => { %>
        <tr class="align-middle text-center">
          <td class="p-4"><%- index + 1 %></td>
          <td>
            <%= order.customerId.name %> (<%= order.customerId.email %>)<br /><br />
            <p id="orderId" data-order-id="<%= order._id %>">Order Id: <%= order._id %></p>
          </td>
          <td><%- order.createdAt.toLocaleDateString('en-GB') %></td>
          <td>
            <% order.items.forEach(item => { %> <%= item.productId.name %><br />
            <% }) %>
          </td>
          <td>
            <p name="paymentStatus" id="paymentStatus" value="<%= order.paymentStatus %>"><%= order.paymentStatus %></p>
          </td>
          <td><%- order.paymentMethod %></td>
          <td>â‚¹<%= order.totalPrice %></td>
          <td>
            <select class="form-select" name="paymentStatus" id="deliveryStatus-<%= order._id %>" data-order-id="<%= order._id %>" aria-label="Select Delivery Status">
              <% statuses.forEach(status => { %>
                <option value="<%= status %>" <%= status === order.commonStatus ? 'selected' : '' %>><%= status %></option>
              <% }); %>
            </select>
          </td>
          <td>
            <div class="d-flex justify-content-center p-4">
              <button type="button" class="btn btn-sm btn-dark update-button" data-order-id="<%= order._id %>">Update</button>
            </div>
          </td>
          
        </tr>
        <% }) %> <% } else { %>
        <td colspan="8" class="text-danger">No Orders Available</td>
        <% } %>
      </tbody>
    </table>
  </div>
</section>

<%- include('../partials/admin/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
document.querySelectorAll('.update-button').forEach(button => {
  button.addEventListener('click', async function(e) {
    e.preventDefault(); // Prevent the default link behavior

    const id = this.getAttribute('data-order-id');
    console.log("this is id", id);
    const selectedStatus = document.querySelector(`#deliveryStatus-${id}`).value;

    fetch(`/admin/orderList/updateOrder/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({id, status: selectedStatus }),
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(err => { throw new Error(err.error); });
      }
      return response.json();
    })
    .then(() => {
      Swal.fire({
        icon: "success",
        title: "Success",
        timer: 3000,
        showConfirmButton: false,
        text: "Order updated successfully!",
      }).then(() => location.reload());
    })
    .catch(err => {
      Swal.fire({
        icon: "error",
        title: "Oops",
        timer: 3000,
        showConfirmButton: false,
        text: "Couldn't update the status of the delivery",
      });
    });
  });
});
</script>
