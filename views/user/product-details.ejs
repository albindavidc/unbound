<%- include('../../views/partials/user/header') %>

<style>
  /* Fixed size for the main image container */
  .product__details__pic__item {
    width: 100%; /* Adjust width as needed */
    max-width: 500px; /* Set a maximum width */
    height: 400px; /* Set a fixed height */
    overflow: hidden; /* Hide overflow */
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product__details__pic__item img {
    width: 100%;
    height: auto; /* Maintain aspect ratio */
    max-height: 100%;
    object-fit: cover; /* Ensure image covers the container without stretching */
  }
</style>
<!-- Shop Details Section Begin -->
<section class="shop-details">
  <div class="product__details__pic">
    <div class="container">
      <div class="row">
        <div class="col-lg-12">
          <div class="product__details__breadcrumb">
            <a href="/">Home</a>
            <a href="/shop">Shop</a>
            <span>Product Details</span>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-lg-3 col-md-3">
          <ul class="nav nav-tabs" role="tablist">
            <!-- Primary Images -->
            <% product.primaryImages.forEach((image, index) => { %>
            <li class="nav-item">
              <a
                class="nav-link <%= index === 0 ? 'active' : '' %>"
                data-toggle="tab"
                href="#tabs-primary"
                role="tab"
                data-image-url="/uploads/images/<%= image.name %>"
              >
                <div class="product__thumb__pic set-bg" data-setbg="/uploads/images/<%= image.name %>"></div>
              </a>
            </li>
            <% }); %>

            <!-- Secondary Images -->
            <% product.secondaryImages.forEach((image, index) => { %>
            <li class="nav-item">
              <a class="nav-link" data-toggle="tab" href="#tabs-<%= index + 1 %>" role="tab" data-image-url="/uploads/images/<%= image.name %>">
                <div class="product__thumb__pic set-bg" data-setbg="/uploads/images/<%= image.name %>"></div>
              </a>
            </li>
            <% }); %>
          </ul>
        </div>
        <div class="col-lg-9 col-md-9">
          <div class="tab-content">
            <!-- Main Image Container -->
            <div class="tab-pane active" id="tabs-primary" role="tabpanel">
              <div class="product__details__pic__item">
                <img
                  id="main-product-image"
                  src="/uploads/images/<%= product.primaryImages[0] ? product.primaryImages[0].name : product.secondaryImages[0].name %>"
                  alt="<%= product.name %>"
                />
              </div>
            </div>
            <% product.secondaryImages.forEach((image, index) => { %>
            <div class="tab-pane" id="tabs-<%= index + 1 %>" role="tabpanel">
              <div class="product__details__pic__item">
                <img id="secondary-product-image-<%= index %>" src="/uploads/images/<%= image.name %>" alt="<%= product.name %>" />
              </div>
            </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="product__details__content">
    <div class="container">
      <div class="row d-flex justify-content-center">
        <div class="col-lg-8">
          <div class="product__details__text">
            <h4><%= product.name %></h4>
            <div class="rating">
              <% for (let i = 0; i < product.rating; i++) { %>
              <i class="fa fa-star"></i>
              <% } %> <% for (let i = product.rating; i < 5; i++) { %>
              <i class="fa fa-star-o"></i>
              <% } %>
            </div>
            <h3 ><%= product.sellingPrice %><span id="productPrice" ><%= product.actualPrice %></span></h3>
            <p><%= product.description %></p>
            <div class="product__details__option">
            </div>

            <div class="product__details__cart__option">
              <div class="quantity">
                <div class="pro-qty">
                  <input name="quantity" type="text"id="productQuantity" value="1" />
                </div>
              </div>

         


              <% let totalStock = 0; // Initialize total stock to 0 %> 
              <% product.variants.forEach(variant => { %> 
                <% totalStock +=variant.stock; // Add stock of each variant %>
                 <% }); %> 

                 
              <div class="mt-3">
                <h4>Variants:</h4>
                <div class="col-12 detail-option mb-3">
                  <h6 class="detail-option-heading">Colour <span>(required)</span></h6>
                  <ul class="list-inline mb-0 colours-wrapper">
                    <% let renderedColors = {}; %>
                    <% product.variants.forEach((variant, index) => { %>
                      <% if (variant.color && !renderedColors[variant.color.hex]) { %>
                        <% renderedColors[variant.color.hex] = true; %>
                        <li class="list-inline-item">
                          <label
                              onclick="selectColor('<%= variant.color.hex %>', '<%= variant.color._id %>', '<%= variant.size._id %>')"
                              class="btn-colour <%= index === 0 ? 'active' : '' %>"
                              for="colour_<%= variant.color.name %>"
                              data-color-hex="<%= variant.color.hex %>" 
                              data-color-id="<%= variant.color._id %>"
                              data-size-id="<%= variant.size._id %>"
                            ></label>
      
                          <input
                            class="input-invisible"
                            type="radio"
                            name="colour"
                            value="<%= variant.color._id %>"
                            id="colour_<%= variant.color.name %>"
                            required
                          />
                        </li>
                      <% } %>
                    <% }); %>
                  </ul>
                </div>
                <div class="col-12 detail-option mb-3">
                  <h6 class="detail-option-heading">Size <span>(required)</span></h6>
                  <ul class="list-inline mb-0 sizes-wrapper">
                    <% let renderedSizes = {}; %>
                    <% product.variants.forEach((variant, index) => { %>
                      <% if (variant.size && !renderedSizes[variant.size.value]) { %>
                        <% renderedSizes[variant.size.value] = true; %>
                        <li class="list-inline-item">
                          <label
                              onclick="selectSize('<%= variant.size.value %>', '<%= variant.size._id %>', '<%= variant.color._id %>')"
                              class="btn btn-sm btn-outline-secondary detail-option-btn-label size-option <%= index === 0 ? 'active' : '' %>"
                              for="size_<%= variant.size.value %>"
                              data-size-value="<%= variant.size.value %>"
                              data-size-id="<%= variant.size._id %>"
                              data-color-id="<%= variant.color._id %>"
                            >
                              <%= variant.size.value %>
                              <input
                                class="input-invisible"
                                type="radio"
                                name="size"
                                value="<%= variant.size._id %>"
                                id="size_<%= variant.size.value %>"
                                required
                              />
                            </label>
                        </li>
                      <% } %>
                    <% }); %>
                  </ul>
                </div>
              </div>





              <% if (totalStock > 0) { %>

                <button class="btn primary-btn btn-outline-secondary" onclick="addToCart('<%- product._id %>')">
                  <i class="bi bi-cart me-2"></i>
                  Add to Cart
                </button>

              <% } else { %>
                <a href="#" class="btn btn-danger">Out of Stock</a>
                <% } %>

        
            </div>
            <div class="product__details__btns__option">
              <a href="#"><i class="fa fa-heart"></i> add to wishlist</a>
              <a href="#"><i class="fa fa-exchange"></i> Add To Compare</a>
            </div>
            <div class="product__details__last__option">
              <h5><span>Guaranteed Safe Checkout</span></h5>
              <img src="../../public/img/shop-details/details-payment.png" alt="" />

                <li>
                  <span>Categories:</span>
                  <%= product.category.name %>
                </li>
    
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!-- Add tabs and other sections here -->
      <div class="tab-pane active" id="tabs-5" role="tabpanel">
        <div class="product__details__tab__content">
          <div class="product__details__tab__content__item">
            <h5>Product Description</h5>
            <p class="note"></p>
          </div>
          <div class="product__details__tab__content__item">
            <h5>About the Company</h5>
            <p></p>
          </div>
        </div>
      </div>
      <div class="tab-pane" id="tabs-6" role="tabpanel">
        <div class="product__details__tab__content">
          <div class="product__details__tab__content__item">
            <h5>Customer Reviews</h5>
            <p></p>
          </div>
        </div>
      </div>
      <div class="tab-pane" id="tabs-7" role="tabpanel">
        <div class="product__details__tab__content">
          <div class="product__details__tab__content__item">
            <h5>Additional Information</h5>
            <p></p>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Shop Details Section End -->
<!-- Related Section Begin -->
<section class="related spad">
  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h3 class="related-title">Related Product</h3>
      </div>
    </div>
    <div class="row">
      <% relatedProducts.forEach(product => { %>
      <div class="col-lg-3 col-md-6 col-sm-6 mb-4">
        <div class="product__item">
          <div class="product__item__pic set-bg" >
            <a href="/user/product-list/<%= product._id %>">

            <img src="/uploads/images/<%= product.primaryImages[0] ? product.primaryImages[0].name : product.secondaryImages[0].name %>"
                        alt="<%= product.productName %>"/>
            </a>
            <span class="label"><%= product.sale ? 'Sale' : 'New' %></span>

            <ul class="product__hover">
              <li>
                <a href="#"><img src="/img/icon/heart.png" alt="" /></a>
              </li>
              <li>
                <a href="#"><img src="/img/icon/compare.png" alt="" /><span>Compare</span></a>
              </li>
              <li>
                <a href="#"><img src="/img/icon/search.png" alt="" /></a>
              </li>
            </ul>
          </div>
          <div class="product__item__text">
            <h6><%= product.name %></h6>

            <% let totalStock = 0; // Initialize total stock to 0 %> 
            <% product.variants.forEach(variant => { %> 
              <% totalStock +=variant.stock; // Add stock of each variant %>
               <% }); %> 
            <% if (totalStock > 0) { %>
            <a href="/user/add-to-cart" class="add-cart">+ Add To Cart</a>
            <% } else { %>
            <a href="#" class="out-of-stock">Out of Stock</a>
            <% } %>

            <div class="rating">
              <% for (let i = 0; i < 5; i++) { %>
              <i class="fa fa-star<%= i < product.rating ? '' : '-o' %>"></i>
              <% } %>
            </div>
            <h5>$<%= product.actualPrice %></h5>
          </div>
        </div>
      </div>
      <% }); %>
    </div>
  </div>
</section>
<!-- Related Section End -->


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


<script defer>
document.addEventListener('DOMContentLoaded', function () {
      const buttons = document.querySelectorAll('.btn-colour');
      buttons.forEach(btn => {
        const hex = btn.getAttribute('data-color-hex');
        btn.style.backgroundColor = hex;
      });
    });

    let selectedColorId = null;
    let selectedSizeId = null;

  const price = document.getElementById("productPrice").textContent;
  const quantity = document.getElementById("productQuantity").value;

    function selectColor(hex, colorId, sizeId) {
      document.querySelectorAll('.btn-colour').forEach(el => el.classList.remove('active'));
      document.querySelector(`.btn-colour[data-color-hex="${hex}"]`).classList.add('active');
      selectedColorId = colorId;
      selectedSizeId = sizeId;
    }

    function selectSize(sizeValue, sizeId, colorId) {
      document.querySelectorAll('.size-option').forEach(el => el.classList.remove('active'));
      document.querySelector(`.size-option[data-size-value="${sizeValue}"]`).classList.add('active');
      selectedSizeId = sizeId;
      selectedColorId = colorId;
    }

    function addToCart(productId) {
      if (selectedColorId && selectedSizeId) {
        fetch('/user/add-to-cart', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            productId,
            // variantId: variantId, 
            colorId: selectedColorId,
            sizeId : selectedSizeId,
            quantity, // Send the quantity
            price,

          }),
        })
        .then(response => {
          if (response.ok) {

            console.log('Product added to cart!');

          } else {
            console.error('Error adding product to cart');
          }
        })
        .then((data) => {
            Swal.fire({
              icon: "success",
              title: "Added to Cart",
              text: "The item has been successfully added to your cart!",
              showCancelButton: true,
              confirmButtonText: "Go to Cart",
              cancelButtonText: "Continue Shopping",
            }).then((result) => {
              if (result.isConfirmed) {
                // Redirect to the cart page
                window.location.href = "/cart";
              }
            });
          })

        .catch((error) => {
          console.error("Error:", error);
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Something went wrong!",
          });
        });
      } else {
        // Handle case where no variant is selected
        alert('Please select a color and size.');
      }
    }
</script>



<!-- <script>
  document.addEventListener('DOMContentLoaded', function () {
    const buttons = document.querySelectorAll('.btn-colour');
    buttons.forEach(btn => {
      const hex = btn.getAttribute('data-color-hex');
      btn.style.backgroundColor = hex;
    });
  });
</script> -->


<%- include('../../views/partials/user/footer') %>
